<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutivo de Gastos Totales</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
        }
        .container {
            padding: 20px;
        }
        #chart {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="chart"></div>
    </div>

    <script>
    async function cargarGastos(url) {
        try {
            const response = await fetch(url);
            return await response.json();
        } catch (error) {
            console.error("Error al cargar los gastos:", error);
            return [];
        }
    }

    function procesarGastos(gastos) {
        let totalGastos = 0;
        gastos.forEach(gasto => {
            let valor = gasto.Total;
            valor = valor.replace('$', '').replace(/\./g, '').replace(',', '.');
            const numero = parseFloat(valor);
            if (!isNaN(numero)) {
                totalGastos += numero;
            }
        });
        return totalGastos;
    }

    function calcularDiferencias(totales) {
        const diferencias = [];
        for (let i = 1; i < totales.length; i++) {
            const diferencia = ((totales[i] - totales[i - 1]) / totales[i - 1]) * 100;
            diferencias.push(diferencia);
        }
        diferencias.unshift(0); // Agregar un 0% para el primer mes
        return diferencias;
    }

    function formatCurrency(value) {
        return `$ ${value.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function generarGrafico(totalJunio, totalJulio, totalAgosto, totalSeptiembre, totalMesActual) {
    const totales = [totalJunio, totalJulio, totalAgosto, totalSeptiembre, totalMesActual];
    const diferencias = calcularDiferencias(totales); // Calcular diferencias porcentuales

    var options = {
        series: [{
            name: 'Total Gastos',
            data: totales // Valores de los cinco meses
        }],
        chart: {
            type: 'area', // Cambiar a gráfico de área
            height: 350,
            toolbar: {
                show: false // Eliminar la barra de herramientas
            },
            dropShadow: {
                enabled: false // Desactivar sombra
            }
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.8,
                opacityTo: 0.6,
                stops: [0, 90, 100]
            }
        },
        stroke: {
            curve: 'straight',
            width: 3, // Grosor de la línea
        },
        markers: {
            size: 4, // Tamaño de los puntos
            colors: ['#f44336'], // Color de los puntos
            strokeColors: '#fff', // Color del borde de los puntos
            strokeWidth: 4,
            hover: {
                size: 8 // Tamaño del punto al pasar el mouse
            }
        },
        grid: {
            show: true,
            borderColor: '#e0e0e0',
            strokeDashArray: 5, // Líneas en puntos
            xaxis: {
                lines: {
                    show: true // Solo líneas verticales
                }
            },
            yaxis: {
                lines: {
                    show: false // Solo líneas verticales
                }
            }
        },
        xaxis: {
            categories: ['Jun', 'Jul', 'Ago', 'Sep', 'Mes Actual'], // Nombres de los meses abreviados
            labels: {
                show: true // Mostrar etiquetas de los meses
            },
            axisBorder: {
                show: false // Eliminar el borde del eje x
            },
            axisTicks: {
                show: false // Eliminar las marcas del eje x
            }
        },
        yaxis: {
            title: {
                text: ''
            },
            labels: {
                formatter: function (value) {
                    return formatCurrency(value);
                },
                show: false // Eliminar etiquetas del eje y
            },
            axisBorder: {
                show: false // Eliminar el borde del eje y
            },
            axisTicks: {
                show: false // Eliminar las marcas del eje y
            }
        },
        tooltip: {
            theme: 'dark',
            y: {
                formatter: function (value) {
                    return formatCurrency(value); // Usar la función formatCurrency para el tooltip
                }
            }
        },
        colors: ['#f44336'], // Color de la línea del gráfico
        dataLabels: {
            enabled: false // Deshabilitar etiquetas de datos en la línea
        },
        annotations: {
            points: [] // Inicializa puntos de anotaciones
        }
    };

    // Agregar anotaciones de las diferencias porcentuales y totales
    for (let i = 0; i < diferencias.length; i++) {
        const textoDiferencia = diferencias[i].toFixed(2) + '%';
        const textoTotal = formatCurrency(totales[i]);
        options.annotations.points.push({
            x: options.xaxis.categories[i], // Mes correspondiente
            y: totales[i], // Valor del mes
            marker: {
                size: 8, // Tamaño del marcador
                fillColor: '#f44336', // Cambiar a cualquier color deseado
                strokeColor: '#fff', // Color del borde del marcador
                strokeWidth: 4, // Grosor del borde del marcador
            },
            label: {
                text: `${textoDiferencia}`, // Texto de la diferencia y total
                style: {
                    color: '#000',
                    background: '#fff',
                    border: '1px solid #000',
                    fontSize: '12px',
                    whiteSpace: 'nowrap' // Evitar el ajuste de línea
                }
            }
        });
    }

    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
}


    async function cargarYMostrarGastos() {
        const urlJunio = 'https://cesarcruz-coto.github.io/coto/DATOS-JUNIO-24/GASTOSUC.json';
        const urlJulio = 'https://cesarcruz-coto.github.io/coto/DATOS-JULIO-24/GASTOSUC.json';
        const urlAgosto = 'https://cesarcruz-coto.github.io/coto/DATOS-AGOSTO-24/GASTOSUC.json';
        const urlSeptiembre = 'https://cesarcruz-coto.github.io/coto/DATOS-SEPTIEMBRE-24/GASTOSUC.json';
        const urlMesActual = 'https://app.sheetlabs.com/TREE/COTOGASTOSUC';

        const [gastosJunio, gastosJulio, gastosAgosto, gastosSeptiembre, gastosMesActual] = await Promise.all([
            cargarGastos(urlJunio),
            cargarGastos(urlJulio),
            cargarGastos(urlAgosto),
            cargarGastos(urlSeptiembre),
            cargarGastos(urlMesActual)
        ]);

        // Procesar los gastos para obtener el total de cada mes
        const totalJunio = procesarGastos(gastosJunio);
        const totalJulio = procesarGastos(gastosJulio);
        const totalAgosto = procesarGastos(gastosAgosto);
        const totalSeptiembre = procesarGastos(gastosSeptiembre);
        const totalMesActual = procesarGastos(gastosMesActual);

        // Generar el gráfico con los totales
        generarGrafico(totalJunio, totalJulio, totalAgosto, totalSeptiembre, totalMesActual);
    }

    // Inicializar la carga y el gráfico
    cargarYMostrarGastos();
    </script>
</body>
</html>
